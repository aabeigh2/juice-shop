name: CI/CD Pipeline with DAST

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # needed for some security tools

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies and build Juice Shop
      run: npm install && npm run build # Or use Docker build

    # --- Deployment Phase (Ephemeral local deployment for DAST) ---
    # Alternatively, you would deploy to a cloud provider here (e.g., Azure/k8s-deploy)
    - name: Start OWASP Juice Shop locally
      run: npm start &
      # Give the application some time to start up
      run: sleep 15 

    # --- DAST Phase (Using OWASP ZAP) ---
    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.14.0
      with:
        target: 'http://localhost:3000' # The local running instance
        # Optional: set a failure threshold (e.g., FAIL ON WARNINGS)
        # rules_file: '.zap/baseline_rules.conf' 
        # issues_as_build_failure: true 

    # You can also use the ZAP Full Scan action for a more in-depth DAST
    # - name: Run OWASP ZAP Full Scan
    #   uses: zaproxy/action-full-scan@v0.12.0
    #   with:
    #     target: 'http://localhost:3000'
    #     # Optional configurations for full scan

    - name: Upload DAST reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ZAP Scan Reports
        path: |
          ./zap_baseline_report.html
          ./zap_baseline_report.json
